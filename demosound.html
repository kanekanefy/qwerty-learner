<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>键盘字母播报（调试修正版）</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        line-height: 1.5;
      }
      button,
      select,
      input {
        margin: 5px 0;
        padding: 6px 10px;
      }
      #log {
        background: #f6f7f9;
        border: 1px solid #ddd;
        padding: 10px;
        height: 300px;
        overflow: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h2>键盘字母播报（调试修正版）</h2>

    <div>
      <button id="btn-enable">① 启用语音</button>
      <button id="btn-test" disabled>② 测试朗读</button>
      <button id="btn-refresh">刷新语音列表</button>
    </div>

    <div>
      <label
        >语音选择:
        <select id="voice" disabled></select
      ></label>
      <span id="voiceCount"></span>
    </div>

    <div>
      <input id="typing" placeholder="输入字母…" disabled />
    </div>

    <h3>调试日志</h3>
    <div id="log"></div>

    <script>
      ;(() => {
        const logBox = document.getElementById('log')
        const btnEnable = document.getElementById('btn-enable')
        const btnTest = document.getElementById('btn-test')
        const btnRefresh = document.getElementById('btn-refresh')
        const selVoice = document.getElementById('voice')
        const voiceCount = document.getElementById('voiceCount')
        const typing = document.getElementById('typing')

        let voices = []

        function log(...args) {
          const msg = args.map((x) => (typeof x === 'string' ? x : JSON.stringify(x))).join(' ')
          logBox.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`
          logBox.scrollTop = logBox.scrollHeight
        }

        function dumpStatus() {
          log(`status | speaking=${speechSynthesis.speaking}, pending=${speechSynthesis.pending}, paused=${speechSynthesis.paused}`)
        }

        function loadVoices() {
          voices = speechSynthesis.getVoices()
          selVoice.innerHTML = ''
          voices.forEach((v, i) => {
            const opt = document.createElement('option')
            opt.value = i
            opt.textContent = `${v.name} (${v.lang})${v.default ? ' [默认]' : ''}`
            selVoice.appendChild(opt)
          })
          voiceCount.textContent = ` 共 ${voices.length} 个语音`
          selVoice.disabled = voices.length === 0
          log('voices loaded:', voices.length)
        }

        function speak(text) {
          dumpStatus()
          const utter = new SpeechSynthesisUtterance(text)
          const v = voices[selVoice.value] || voices[0]
          if (v) utter.voice = v

          utter.onstart = () => log(`utterance start: "${text}" via ${utter.voice ? utter.voice.name : 'default'}`)
          utter.onend = () => log(`utterance end: "${text}"`)
          utter.onerror = (e) => log(`utterance error: ${e.error || e}`)

          try {
            speechSynthesis.speak(utter)
            log('speak() called with text:', text)
          } catch (e) {
            log('speak exception:', e.message || e)
          }
        }

        btnEnable.addEventListener('click', () => {
          typing.disabled = false
          btnTest.disabled = false
          typing.focus()
          log('enable clicked → 输入框已解锁，可以尝试输入字母')

          loadVoices()
          speak('speech ready') // 即使失败也能打印日志
        })

        btnTest.addEventListener('click', () => {
          speak('Hello world, 你好世界')
        })

        btnRefresh.addEventListener('click', () => {
          loadVoices()
        })

        typing.addEventListener('keydown', (e) => {
          const ch = e.key.toUpperCase()
          if (/^[A-Z]$/.test(ch)) {
            speak(ch)
            e.preventDefault()
          }
        })

        speechSynthesis.onvoiceschanged = () => {
          log('onvoiceschanged fired')
          loadVoices()
        }
      })()
    </script>
  </body>
</html>
