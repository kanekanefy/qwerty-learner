# 功能开发规划：阅读障碍友好改造

## 1. 文档信息

- 版本：v0.1
- 修订日期：2024-05-xx
- 面向对象：前端开发、设计、测试、运营、特教顾问

## 2. 开发目标

- 在 16 周内完成阅读障碍友好模式 MVP（含 Must 功能），并建立可持续迭代框架。
- 输出对齐 PRD 的可交付件：视觉/字体配置、多感官练习、词库与数据报告、自动化测试。
- 为后续家长/教师端扩展预留接口和状态结构。

## 3. 迭代节奏

| 阶段            | 时长        | 核心里程碑                       | 验收要点                                                          |
| --------------- | ----------- | -------------------------------- | ----------------------------------------------------------------- |
| M1 无障碍基础   | 第 1-4 周   | 字体/配色设置、音节拆分完成      | 设置面板、练习场景可切换字体与主题；音节高亮准确率 ≥95% 样本覆盖  |
| M2 多感官整合   | 第 5-10 周  | 分段音频、图像联想、奖励反馈上线 | 输入流程可播放音节音频、展示插图、积分累积生效；性能无明显回退    |
| M3 个性化与数据 | 第 11-16 周 | 高频词策略、错词报告、间隔重复   | 报告页展示统计；错词复习任务生成正确；Playwright 脚本覆盖新增页面 |

## 4. 任务分解

### 4.1 设置与无障碍

| 编号 | 功能点                | 主要改动文件                                              | 技术方案                                                                            | 验收                                        |
| ---- | --------------------- | --------------------------------------------------------- | ----------------------------------------------------------------------------------- | ------------------------------------------- |
| A1   | 字体与颜色设置面板    | `src/pages/settings/*`, `src/store/userPreference.ts`     | 扩展 Jotai store 保存 `fontFamily`, `contrastTheme`; 使用 Tailwind CSS 变量动态切换 | 页面能实时预览字体，刷新后保持选择          |
| A2   | OpenDyslexic 字体接入 | `public/fonts`, `src/index.css`                           | 引入 WOFF/WOFF2 文件，@font-face 注册；提供 fallback；检测加载失败回退默认字体      | 应用加载无闪烁，Lighthouse 可访问性评分提升 |
| A3   | 音节拆分渲染          | `src/utils/phonics.ts`, `src/components/PracticeWord.tsx` | 构建音节拆分库（硬编码规则 + 自定义映射 JSON），在渲染时将单词切片并标色            | 对测试样例表（100 词）拆分正确率 ≥95%       |

### 4.2 多感官练习

| 编号 | 功能点       | 主要改动文件                                                   | 技术方案                                                                                          | 验收                                          |
| ---- | ------------ | -------------------------------------------------------------- | ------------------------------------------------------------------------------------------------- | --------------------------------------------- |
| B1   | 分段音频播放 | `src/hooks/useAudioPlayer.ts`, `src/utils/audioSplit.ts`       | 预处理音节时间戳（脚本写入 JSON），前端根据输入进度播放 segment；Fallback 使用 Web Audio API 分段 | 正确输入每个音节后正常播放，错误时仅重放该段  |
| B2   | 图像联想展示 | `src/components/PracticeSidebar.tsx`, `src/store/resources.ts` | 词条扩展 `imageUrl` 字段；IndexedDB 缓存图像；加载失败显示占位图                                  | 95% 图片在首屏<300ms 展示；离线模式可读取缓存 |
| B3   | 错误提示动画 | `src/components/FeedbackOverlay.tsx`                           | 使用 Framer Motion/Tailwind 动画；展示正确字母轮廓和发音提示                                      | 动画在 600ms 内结束且不阻塞输入               |
| B4   | 奖励系统     | `src/store/reward.ts`, `src/components/RewardToast.tsx`        | 新建积分 store，动作触发器可配置；与 UI 粒子效果组件结合                                          | 奖励提示可开关；数据在报告中可见              |

### 4.3 词库与个性化

| 编号 | 功能点         | 主要改动文件                                                              | 技术方案                                                                   | 验收                                 |
| ---- | -------------- | ------------------------------------------------------------------------- | -------------------------------------------------------------------------- | ------------------------------------ |
| C1   | 高频词词库整合 | `src/resources/vocabulary/high-frequency.json`, `src/store/lessonPlan.ts` | 引入 CEFR 词表，添加频度标签；生成每日任务算法（随机+薄弱词优先）          | 每日练习列表数量可配置；重复率 <10%  |
| C2   | 自定义词库导入 | `src/components/WordsetImporter.tsx`                                      | 支持 CSV/JSON 上传，利用 Papaparse；字段包含 `word`,`image`,`audio`,`note` | 异常输入有友好提示；校验后存入 Dexie |
| C3   | 间隔重复引擎   | `src/utils/spacedRepetition.ts`, `src/store/reviewQueue.ts`               | 实现 Leitner 箱模型，结合练习结果调整优先级；每日生成复习任务              | 薄弱词在 24h 内重新出现；指标可导出  |
| C4   | 报告页面       | `src/pages/report/*`, `src/components/charts/*`                           | 基于 ECharts 渲染趋势图和错词热力；支持导出 PDF（html2canvas）             | 报告展示准确；导出文件 ≤2MB          |

### 4.4 自动化与基础设施

| 编号 | 功能点              | 主要改动文件             | 技术方案                                                                   | 验收                             |
| ---- | ------------------- | ------------------------ | -------------------------------------------------------------------------- | -------------------------------- |
| D1   | Playwright 场景扩充 | `tests/e2e/*.spec.ts`    | 新增字体切换、音频触发、奖励积分、报表导出等脚本；引入辅助函数封装常用操作 | CI 通过率 ≥95%，运行时间 ≤6 分钟 |
| D2   | 内容校验工具        | `scripts/`               | 编写 Node 脚本校验音节映射、词库图片链接、音频文件存在性                   | Pre-commit 检测通过方可提交      |
| D3   | 指标埋点            | `src/utils/analytics.ts` | 增补事件常量与 Mixpanel/SW 采集逻辑，支持开关                              | 文档记录事件含义；QA 可查日志    |

## 5. 技术方案详解

- **音节拆分**：前端直接使用 `compromise-speech` 规则库实时拆分，`getSyllables` 提供缓存与兜底正则，配合音节颜色渲染；若需强制修正可通过 overrides 扩展。
- **音频切分**：新增 CLI（`scripts/audio-split.ts`）读取原始 MP3，根据词典时间戳输出 WebM 片段或 JSON 元数据。前端播放时，优先加载本地片段，若缺失则退化为整段播放。
- **IndexedDB 缓存**：使用 Dexie 表 `mediaAssets`，存储图片 Base64 与音频段路径，设置 TTL（默认 30 天）。为避免膨胀，需在启动时执行清理策略。
- **状态管理**：所有新偏好值放入 `userPreferenceAtom`，通过 `persistAtom` 辅助器写入 localStorage/Dexie。奖励与任务另起 atom，便于后续多账号扩展。
- **可访问性**：引入 `aria-live`、`aria-describedby` 支持，满足屏幕阅读器兼容；配合 Playwright 使用 `page.accessibility.snapshot()` 校验。

## 6. 测试计划

- 单元测试：为 `utils` 增加 Jest 测试（音节拆分、间隔重复算法）。
- 端到端：Playwright 每阶段补充关键脚本；在 CI 中分别跑 Chromium 与 WebKit。
- 可用性测试：邀请至少两所特教学校的 15 名学生参与，记录可访问性反馈。
- 性能监控：使用 Lighthouse/ Web Vitals，对比改造前后 FCP、CLS，目标不劣化 10% 以上。

## 7. 发布与灰度

- M1 完成后先上线隐藏入口（设置页开关），收集内部反馈。
- M2 推出公测活动，提供邀请码机制控制规模。
- M3 正式发布，更新官网与 README，并准备多语言介绍。
- 桌面版（Tauri）在 M2 时开始评估，M3 后发布 Beta。

## 8. 资源与分工

- 前端：2 人（无障碍负责人、多感官体验负责人）。
- 设计：1 人，输出字体/配色规范与插画模板。
- 测试：1 人，负责自动化脚本与用户测试组织。
- 特教顾问：提供音节校正、练习流程建议，参与可用性回访。

## 9. 风险与应对

- **字体授权风险**：同步法务确认；若延迟，先上线开源字体并允许上传个人字体。
- **媒体资源缺失**：建立资源缺省策略（占位图、提示），并在导入流程做校验。
- **性能退化**：动画与音频加载需延迟执行；CDN 缓存资源；引入懒加载。
- **孩子隐私**：在自定义词库与报告中加入家长协议弹窗，自定义数据默认仅本地存储。

## 10. 未决事项

- 是否引入后端服务同步练习数据（需与运营评估成本）。
- 键盘触觉反馈实现方式（硬件兼容、浏览器限制）。
- 家长/教师账号体系所需的认证方案（是否与现有登录合并）。

## 11. 文档与交付要求

- 与本规划配套的设计稿、音节词典、脚本需存于 `docs/` 或 `scripts/` 并记录使用说明。
- 每阶段结束前更新周报（含指标与风险），并同步至团队知识库。
- 开发完成后更新 `README`、`AGENTS.md`、PRD 状态。
